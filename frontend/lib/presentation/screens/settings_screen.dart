import 'package:flutter/material.dart';
import 'package:flutter_riverpod/flutter_riverpod.dart';
import '../../config/constants.dart';
import '../../domain/entities/user_profile.dart';
import '../providers/user_provider.dart';
import '../widgets/main_layout.dart';

/// ÏÑ§Ï†ï ÌôîÎ©¥
class SettingsScreen extends ConsumerStatefulWidget {
  const SettingsScreen({Key? key}) : super(key: key);

  @override
  ConsumerState<SettingsScreen> createState() => _SettingsScreenState();
}

class _SettingsScreenState extends ConsumerState<SettingsScreen> {
  String _selectedGender = 'male';
  String _selectedAgeGroup = 'ÏÑ±Ïù∏';
  bool _notificationsEnabled = true;
  bool _highPriorityNotifications = true;
  bool _soundEnabled = true;

  // ü©∫ ÏßàÌôò Î™©Î°ù ÎèôÏ†Å Ï∂îÍ∞ÄÏö© Î¶¨Ïä§Ìä∏
  final List<TextEditingController> _diseaseControllers = [];

  @override
  void initState() {
    super.initState();
    _loadUserProfile();
    _addDiseaseField(); // Í∏∞Î≥∏ 1Í∞ú ÌïÑÎìú ÏÉùÏÑ±
  }

  void _addDiseaseField() {
    setState(() {
      _diseaseControllers.add(TextEditingController());
    });
  }

  void _removeDiseaseField(int index) {
    setState(() {
      _diseaseControllers.removeAt(index);
    });
  }

  void _loadUserProfile() {
    final userProfileAsync = ref.read(userProfileProvider);
    userProfileAsync.whenData((profile) {
      if (profile != null) {
        setState(() {
          _selectedAgeGroup = profile.ageGroup;
          _notificationsEnabled = profile.notificationsEnabled;
          _highPriorityNotifications = profile.highPriorityNotifications;
          _soundEnabled = profile.soundEnabled;
        });
      }
    });
  }

  @override
  Widget build(BuildContext context) {
    final textTheme = Theme.of(context).textTheme;

    return MainLayout(
      currentIndex: 3, // ÌõàÎ†® ÏãúÏä§ÌÖú Ï∂îÍ∞ÄÎ°ú Ïù∏Îç±Ïä§ Î≥ÄÍ≤Ω (Ìôà/ÌõàÎ†®/Î≥¥ÏÉÅ/ÏÑ§Ï†ï)
      child: Scaffold(
        appBar: AppBar(
          title: const Text('ÏÑ§Ï†ï'),
        ),
        body: SingleChildScrollView(
          padding: const EdgeInsets.all(AppConstants.paddingLarge),
          child: Column(
            crossAxisAlignment: CrossAxisAlignment.start,
            children: [
              /// üßç‚Äç‚ôÇÔ∏è Í∞úÏù∏ Ï†ïÎ≥¥ ÏÑπÏÖò
              Text(
                'Í∞úÏù∏ Ï†ïÎ≥¥',
                style: textTheme.headlineSmall?.copyWith(
                  fontWeight: FontWeight.bold,
                  fontSize: (textTheme.headlineSmall?.fontSize ?? 20) + 2,
                ),
              ),
              const SizedBox(height: 16),

              Card(
                child: Padding(
                  padding: const EdgeInsets.all(AppConstants.paddingLarge),
                  child: Column(
                    crossAxisAlignment: CrossAxisAlignment.start,
                    children: [
                      _buildGenderSection(context),
                      const Divider(height: 24),
                      _buildAgeSection(context),
                      const Divider(height: 24),

                      // ü©∫ ‚ÄúÏïìÍ≥† ÏûàÎäî ÏßàÌôòÏù¥ ÏûàÎÇòÏöî?‚Äù ÏÑπÏÖò
                      Row(
                        mainAxisAlignment: MainAxisAlignment.spaceBetween,
                        children: [
                          Text(
                            'ÏïìÍ≥† ÏûàÎäî ÏßàÌôòÏù¥ ÏûàÎÇòÏöî?',
                            style: textTheme.titleMedium?.copyWith(
                              fontWeight: FontWeight.w600,
                              fontSize:
                                  (textTheme.titleMedium?.fontSize ?? 16) + 2,
                            ),
                          )
                        ],
                      ),
                      Column(
                        children: List.generate(_diseaseControllers.length, (index) {
                          return Padding(
                            padding: const EdgeInsets.only(bottom: 12),
                            child: Row(
                              children: [
                                Expanded(
                                  child: TextField(
                                    controller: _diseaseControllers[index],
                                    style: const TextStyle(fontSize: 16),
                                    decoration: InputDecoration(
                                      labelText: 'ÏßàÌôò ${index + 1}',
                                      labelStyle: TextStyle(
                                          fontSize: (textTheme.bodyMedium?.fontSize ?? 14) + 2),
                                      hintText: 'Ïòà: Í≥†ÌòàÏïï, Ï≤úÏãù Îì±',
                                      hintStyle: TextStyle(
                                          fontSize: (textTheme.bodySmall?.fontSize ?? 12) + 2),
                                      border: const OutlineInputBorder(),
                                    ),
                                  ),
                                ),
                                const SizedBox(width: 8),
                                IconButton(
                                  icon: const Icon(Icons.remove_circle_outline),
                                  color: Colors.redAccent,
                                  onPressed: () => _removeDiseaseField(index),
                                ),
                              ],
                            ),
                          );
                        }),
                      ),
                      Center(
                      child: IconButton(
                        icon: const Icon(Icons.add_circle_outline),
                        color: Theme.of(context).colorScheme.primary,
                        iconSize: 28,
                        tooltip: "ÏßàÌôò Ìï≠Î™© Ï∂îÍ∞Ä",
                        onPressed: _addDiseaseField,
                      ),
                    ),
                    ],
                  ),
                ),
              ),

              const SizedBox(height: 24),

              /// üîî ÏïåÎ¶º ÏÑ§Ï†ï
              Text(
                'ÏïåÎ¶º ÏÑ§Ï†ï',
                style: textTheme.headlineSmall?.copyWith(
                  fontWeight: FontWeight.bold,
                  fontSize: (textTheme.headlineSmall?.fontSize ?? 20) + 2,
                ),
              ),
              const SizedBox(height: 16),
              _buildNotificationSettings(context),

              const SizedBox(height: 24),

              /// üì± Ïï± Ï†ïÎ≥¥
              _buildAppInfoSection(context),

              const SizedBox(height: 24),

              /// üíæ Ï†ÄÏû• Î≤ÑÌäº
              SizedBox(
                width: double.infinity,
                child: FilledButton.icon(
                  onPressed: _saveSettings,
                  icon: const Icon(Icons.save),
                  label: const Text('ÏÑ§Ï†ï Ï†ÄÏû•', style: TextStyle(fontSize: 18)),
                ),
              ),
              const SizedBox(height: 24),
            ],
          ),
        ),
      ),
    );
  }

  /// üë© ÏÑ±Î≥Ñ
  Widget _buildGenderSection(BuildContext context) {
    final textTheme = Theme.of(context).textTheme;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Icon(Icons.wc, size: 22, color: Theme.of(context).colorScheme.primary),
            const SizedBox(width: 8),
            Text(
              'ÏÑ±Î≥Ñ',
              style: textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w600,
                fontSize: (textTheme.titleMedium?.fontSize ?? 16) + 2,
              ),
            ),
          ],
        ),
        const SizedBox(height: 12),
        Row(
          children: [
            _genderButton(context, 'male', 'ÎÇ®ÏÑ±', Icons.male),
            _genderButton(context, 'female', 'Ïó¨ÏÑ±', Icons.female),
          ],
        ),
      ],
    );
  }

  Widget _genderButton(BuildContext context, String value, String label, IconData icon) {
    final isSelected = _selectedGender == value;
    return Expanded(
      child: Padding(
        padding: const EdgeInsets.symmetric(horizontal: 4),
        child: InkWell(
          onTap: () => setState(() => _selectedGender = value),
          borderRadius: BorderRadius.circular(AppConstants.borderRadiusMedium),
          child: Container(
            padding: const EdgeInsets.symmetric(horizontal: 12, vertical: 14),
            decoration: BoxDecoration(
              color: isSelected ? Theme.of(context).colorScheme.primary : Colors.grey[100],
              borderRadius: BorderRadius.circular(AppConstants.borderRadiusMedium),
              border: Border.all(
                color: isSelected ? Theme.of(context).colorScheme.primary : Colors.grey[300]!,
                width: 1.5,
              ),
            ),
            child: Row(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Icon(icon, size: 22, color: isSelected ? Colors.white : Colors.grey[700]),
                const SizedBox(width: 6),
                Text(
                  label,
                  style: TextStyle(
                    fontSize: 17,
                    fontWeight: isSelected ? FontWeight.w600 : FontWeight.w500,
                    color: isSelected ? Colors.white : Colors.grey[800],
                  ),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }

  /// üë∂ Ïó∞Î†πÎåÄ
  Widget _buildAgeSection(BuildContext context) {
    final textTheme = Theme.of(context).textTheme;

    return Column(
      crossAxisAlignment: CrossAxisAlignment.start,
      children: [
        Row(
          children: [
            Icon(Icons.person_outline, size: 22, color: Theme.of(context).colorScheme.primary),
            const SizedBox(width: 8),
            Text(
              'Ïó∞Î†πÎåÄ',
              style: textTheme.titleMedium?.copyWith(
                fontWeight: FontWeight.w600,
                fontSize: (textTheme.titleMedium?.fontSize ?? 16) + 2,
              ),
            ),
          ],
        ),
        const SizedBox(height: 8),
        Wrap(
          spacing: 8,
          runSpacing: 8,
          children: ['Ïñ¥Î¶∞Ïù¥', 'Ï≤≠ÏÜåÎÖÑ', 'ÏÑ±Ïù∏', 'ÎÖ∏Ïù∏']
              .map((age) => ChoiceChip(
                    label: Text(
                      age,
                      style: TextStyle(fontSize: 16),
                    ),
                    selected: _selectedAgeGroup == age,
                    onSelected: (_) => setState(() => _selectedAgeGroup = age),
                    selectedColor: Theme.of(context).colorScheme.primary,
                    labelStyle: TextStyle(
                      color: _selectedAgeGroup == age ? Colors.white : Colors.grey[800],
                    ),
                  ))
              .toList(),
        ),
      ],
    );
  }

  /// üîî ÏïåÎ¶º ÏÑ§Ï†ï
  Widget _buildNotificationSettings(BuildContext context) {
    final textTheme = Theme.of(context).textTheme;
    return Card(
      child: Padding(
        padding: const EdgeInsets.all(AppConstants.paddingLarge),
        child: Column(
          children: [
            SwitchListTile(
              title: Text('ÏúÑÏπò Í∏∞Î∞ò ÏïåÎ¶º', style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 16) + 2)),
              subtitle: Text('ÌòÑÏû¨ ÏúÑÏπò Í∏∞Î∞ò Ïû¨ÎÇú ÏïåÎ¶º ÏàòÏã†', style: TextStyle(fontSize: (textTheme.bodySmall?.fontSize ?? 12) + 2)),
              value: _notificationsEnabled,
              onChanged: (value) => setState(() => _notificationsEnabled = value),
            ),
            const Divider(),
            SwitchListTile(
              title: Text('ÎÜíÏùÄ Ïö∞ÏÑ†ÏàúÏúÑ', style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 16) + 2)),
              subtitle: Text('Ï§ëÏöîÌïú ÏïåÎ¶ºÏùÑ Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú ÌëúÏãú', style: TextStyle(fontSize: (textTheme.bodySmall?.fontSize ?? 12) + 2)),
              value: _highPriorityNotifications,
              onChanged: (value) => setState(() => _highPriorityNotifications = value),
            ),
            const Divider(),
            SwitchListTile(
              title: Text('ÏÜåÎ¶¨ ÏïåÎ¶º', style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 16) + 2)),
              subtitle: Text('ÏïåÎ¶º ÏàòÏã† Ïãú ÏÜåÎ¶¨ Ïû¨ÏÉù', style: TextStyle(fontSize: (textTheme.bodySmall?.fontSize ?? 12) + 2)),
              value: _soundEnabled,
              onChanged: (value) => setState(() => _soundEnabled = value),
            ),
          ],
        ),
      ),
    );
  }

  /// üì± Ïï± Ï†ïÎ≥¥
  Widget _buildAppInfoSection(BuildContext context) {
    final textTheme = Theme.of(context).textTheme;
    return Card(
      child: Column(
        children: [
          ListTile(
            leading: const Icon(Icons.info_outline),
            title: Text('Ïï± Î≤ÑÏ†Ñ',
                style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 14) + 2)),
            trailing: Text(AppConstants.appVersion,
                style: TextStyle(fontSize: (textTheme.bodySmall?.fontSize ?? 12) + 2)),
          ),
          const Divider(),
          ListTile(
            leading: const Icon(Icons.privacy_tip_outlined),
            title: Text('Í∞úÏù∏Ï†ïÎ≥¥ Ï≤òÎ¶¨Î∞©Ïπ®',
                style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 14) + 2)),
            trailing: const Icon(Icons.chevron_right),
          ),
          const Divider(),
          ListTile(
            leading: const Icon(Icons.description_outlined),
            title: Text('ÏÑúÎπÑÏä§ ÏïΩÍ¥Ä',
                style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 14) + 2)),
            trailing: const Icon(Icons.chevron_right),
          ),
          const Divider(),
          ListTile(
            leading: const Icon(Icons.help_outline),
            title: Text('ÎèÑÏõÄÎßê',
                style: TextStyle(fontSize: (textTheme.bodyLarge?.fontSize ?? 14) + 2)),
            trailing: const Icon(Icons.chevron_right),
          ),
        ],
      ),
    );
  }

  /// Ï†ÄÏû•
  Future<void> _saveSettings() async {
    final diseases = _diseaseControllers.map((c) => c.text).where((t) => t.isNotEmpty).join(', ');
    final profile = UserProfile(
      ageGroup: _selectedAgeGroup,
      notificationsEnabled: _notificationsEnabled,
      highPriorityNotifications: _highPriorityNotifications,
      soundEnabled: _soundEnabled,
      disease: diseases,
      lastUpdated: DateTime.now(),
    );

    await ref.read(userProfileNotifierProvider.notifier).updateProfile(profile);

    if (mounted) {
      ScaffoldMessenger.of(context).showSnackBar(
        const SnackBar(
          content: Text('ÏÑ§Ï†ïÏù¥ Ï†ÄÏû•ÎêòÏóàÏäµÎãàÎã§'),
          behavior: SnackBarBehavior.floating,
        ),
      );
    }
  }
}
